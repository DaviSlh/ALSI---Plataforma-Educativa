<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ALSI - Plataforma Educativa</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    /* Tus estilos CSS existentes */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      display: flex;
      height: 100vh;
      background-color: #f9f6fb;
      color: #4a3054;
    }
    aside {
      width: 220px;
      background-color: #c39bd3;
      padding: 2rem 1rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      color: white;
      align-items: center;
    }
    aside img {
      width: 130px;
      height: auto;
      margin-bottom: 1.5rem;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }
    aside h1 {
      font-size: 1.8rem;
      margin-bottom: 2rem;
      text-align: center;
    }
    aside button {
      background: none;
      border: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      padding: 0.5rem;
      text-align: left;
      width: 100%;
      transition: background 0.3s;
    }
    aside button:hover {
      background-color: #af7ac5;
      border-radius: 8px;
    }
    main {
      flex: 1;
      padding: 2rem;
      overflow-y: auto;
      position: relative;
    }
    .progress-bar-container {
      background-color: #e8dff3;
      height: 6px;
      width: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }
    .progress-bar-fill {
      background-color: #b27ac5;
      height: 100%;
      width: 0%;
      transition: width 0.6s ease;
    }
    .search-container {
      margin: 1.5rem 0;
    }
    .search-container input {
      width: 100%;
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
    }
    .lessons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
    }
    .lesson-card {
      background: #fff;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      text-align: center;
      position: relative;
      cursor: pointer;
      transition: transform 0.2s ease;
    }
    .lesson-card:hover {
      transform: scale(1.02);
    }
    .lesson-card h3 { margin: 0 0 0.5rem; }
    .lesson-card p { font-size: 0.9rem; color: #555; margin-bottom: 1rem; }
    .lesson-card button {
      background-color: #c39bd3;
      color: #fff;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      cursor: pointer;
      font-weight: bold;
    }
    .lesson-card.completed {
      border: 2px solid #af7ac5;
    }
    .lesson-card .check {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 1.5rem;
      color: #28a745;
    }
    /* Estilos para lecciones bloqueadas */
    .lesson-card.locked {
        opacity: 0.5;
        pointer-events: none;
        cursor: not-allowed;
    }
    .lesson-card.locked button {
        background-color: #ccc; /* Botón deshabilitado */
        cursor: not-allowed;
    }
    .lesson-card.locked .unlock-message {
        color: #777;
        font-size: 0.85rem;
        margin-top: 10px;
    }

    #perfil form {
      max-width: 400px;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    #perfil input {
      padding: 0.6rem;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    #perfil button {
      width: fit-content;
      background-color: #c39bd3;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 8px;
      cursor: pointer;
    }
    .logo-movil {
      display: none;
    }
    @media (max-width: 768px) {
      body {
        flex-direction: column;
      }
      aside {
        width: 100%;
        flex-direction: row;
        justify-content: space-around;
        padding: 1rem;
        position: sticky;
        top: 0;
        z-index: 1000;
      }
      aside img,
      aside h1 {
        display: none;
      }
      aside button {
        flex: 1;
        font-size: 0.9rem;
        padding: 0.5rem;
      }
      main {
        padding: 1rem;
      }
      .lessons {
        grid-template-columns: 1fr;
      }
      .lesson-card {
        padding: 1rem;
      }
      .logo-movil {
        display: block;
        position: fixed;
        top: 10px;
        right: 10px;
        width: 50px;
        height: auto;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 1001;
      }
    }
    /* Modo oscuro */
    body.dark-mode {
      background-color: #121212;
      color: #e0d8f0;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark-mode aside {
      background-color: #3a2a52;
      color: #dcd6f7;
    }
    body.dark-mode aside button {
      color: #dcd6f7;
    }
    body.dark-mode aside button:hover {
      background-color: #6b5498;
    }
    body.dark-mode main {
      background-color: #1e1b29;
      color: #e0d8f0;
    }
    body.dark-mode .lesson-card {
      background-color: #2b2440;
      color: #ddd;
      box-shadow: 0 6px 16px rgba(255, 255, 255, 0.1);
    }
    body.dark-mode .lesson-card button {
      background-color: #6b5498;
      color: #fff;
    }
    body.dark-mode .lesson-card.completed {
      border-color: #a87ce2;
    }
    body.dark-mode .progress-bar-container {
      background-color: #4e3f70;
    }
    body.dark-mode .progress-bar-fill {
      background-color: #a87ce2;
    }
    body.dark-mode #perfilResumen {
      background-color: #3a2a52;
      color: #e0d8f0;
    }
    body.dark-mode #perfil input {
      background-color: #4e3f70;
      color: #ddd;
      border-color: #6b5498;
    }
    body.dark-mode #perfil button {
      background-color: #6b5498;
      color: white;
    }
    body.dark-mode .search-container input {
      background-color: #4e3f70;
      color: #ddd;
      border-color: #6b5498;
    }
    body.dark-mode {
      background-color: #1e1e2f;  /* Fondo oscuro */
      color: #ffffff;             /* Letras blancas */
    }
    body.dark-mode h1,
    body.dark-mode h2,
    body.dark-mode h3,
    body.dark-mode p,
    body.dark-mode span,
    body.dark-mode li,
    body.dark-mode input,
    body.dark-mode button,
    body.dark-mode label {
      color: #ffffff;
    }
  </style>
</head>
<body>
  <img class="logo-movil" src="https://i.postimg.cc/gktsPS9Z/1000040884.png" alt="Logo ALSI móvil" />
  <aside>
    <img src="https://i.postimg.cc/gktsPS9Z/1000040884.png" alt="Logo ALSI" />
    <h1>ALSI</h1>
    <button onclick="showSection('lecciones')">Lecciones</button>
    <button onclick="showSection('progreso')">Progreso</button>
    <button onclick="showSection('perfil')">Perfil</button>
   <button type="button" onclick="cerrarSesion()">Salir</button>
   <button id="toggle-dark-mode" type="button">🌙 Modo Oscuro</button>
  </aside>
  <main>
    <div class="progress-bar-container">
      <div class="progress-bar-fill" id="progressFill"></div>
    </div>

    <section id="lecciones">
      <h2>Elige una lección para comenzar</h2>
      <div class="search-container">
        <input type="text" id="busqueda" placeholder="Buscar lección..." oninput="filtrarLecciones()" />
      </div>
      <div class="lessons" id="lessons-container">
        <div class="lesson-card" id="lesson1" data-leccion-id="1" data-titulo="Lección 1" data-quiz-required="false">
          <img src="TP1/leccion1.png" alt="Lección 1" style="width:100%;border-radius:12px;margin-bottom:1rem;">
          <h3>Lección 1</h3>
          <p>Introducción a las señas básicas.</p>
          </div>

        <div class="lesson-card" id="lesson2" data-leccion-id="2" data-titulo="Lección 2" data-quiz-required="true" data-min-score="70">
          <img src="TP1/leccion2.png" alt="Lección 2" style="width:100%;border-radius:12px;margin-bottom:1rem;">
          <h3>Lección 2</h3>
          <p>Abecedario dactilológico.</p>
          </div>

        <div class="lesson-card" id="lesson3" data-leccion-id="3" data-titulo="Lección 3" data-quiz-required="false">
          <img src="TP1/leccion3.png" alt="Lección 3" style="width:100%;border-radius:12px;margin-bottom:1rem;">
          <h3>Lección 3</h3>
          <p>Colores y números.</p>
        </div>

        <div class="lesson-card" id="lesson4" data-leccion-id="4" data-titulo="Lección 4" data-quiz-required="true" data-min-score="60">
          <img src="TP1/leccion4.png" alt="Lección 4" style="width:100%;border-radius:12px;margin-bottom:1rem;">
          <h3>Lección 4</h3>
          <p>Días de la semana y tiempo.</p>
        </div>
        </div>
    </section>

    <section id="progreso" style="display:none">
      <h2>Progreso del usuario</h2>
      <ul id="lista-progreso"></ul>
      <button type="button" onclick="reiniciarProgreso()" style="margin-top: 1rem; background-color: #e74c3c; color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer;">
        Reiniciar progreso
      </button>
    </section>

    <section id="perfil" style="display:none">
      <h2>Perfil del usuario</h2>
      <form onsubmit="guardarPerfil(event)" id="form-perfil">
        <input type="text" id="nombre" placeholder="Nombre" />
        <input type="email" id="correo" placeholder="Correo electrónico" />
       <button type="submit">Guardar perfil</button>
      </form>
    <div id="contenido-leccion"></div>
  </main>

  <script>
    // Tu script de Dark Mode y manejo de secciones existente
    const toggleDarkModeBtn = document.getElementById('toggle-dark-mode');
    const body = document.body;

    function aplicarModoOscuroInicial() {
      const savedMode = localStorage.getItem('darkMode');
      if (savedMode === 'enabled') {
        body.classList.add('dark-mode');
        toggleDarkModeBtn.textContent = '☀️ Modo Claro';
      } else if (savedMode === 'disabled') {
        body.classList.remove('dark-mode');
        toggleDarkModeBtn.textContent = '🌙 Modo Oscuro';
      } else {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
          body.classList.add('dark-mode');
          toggleDarkModeBtn.textContent = '☀️ Modo Claro';
        } else {
          body.classList.remove('dark-mode');
          toggleDarkModeBtn.textContent = '🌙 Modo Oscuro';
        }
      }
    }

    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
        if (!localStorage.getItem('darkMode')) {
          if (event.matches) {
            body.classList.add('dark-mode');
            toggleDarkModeBtn.textContent = '☀️ Modo Claro';
          } else {
            body.classList.remove('dark-mode');
            toggleDarkModeBtn.textContent = '🌙 Modo Oscuro';
          }
        }
      });
    }

    toggleDarkModeBtn.addEventListener('click', () => {
      body.classList.toggle('dark-mode');
      if (body.classList.contains('dark-mode')) {
        toggleDarkModeBtn.textContent = '☀️ Modo Claro';
        localStorage.setItem('darkMode', 'enabled');
      } else {
        toggleDarkModeBtn.textContent = '🌙 Modo Oscuro';
        localStorage.setItem('darkMode', 'disabled');
      }
    });

    function showSection(id) {
      const secciones = ['lecciones', 'progreso', 'perfil'];
      secciones.forEach(sec => {
        document.getElementById(sec).style.display = sec === id ? 'block' : 'none';
      });
      // Cuando se muestra la sección de progreso, actualizar la lista
      if (id === 'progreso') {
          displayProgress();
      }
    }

    function guardarPerfil(event) {
      event.preventDefault();
      const nombre = document.getElementById('nombre').value;
      const correo = document.getElementById('correo').value;
      const perfil = { nombre, correo };
      localStorage.setItem('perfilUsuario', JSON.stringify(perfil));
      alert('¡Perfil guardado exitosamente!');
    }

    function reiniciarProgreso() {
        if (confirm('¿Estás seguro de que quieres reiniciar tu progreso? Se borrarán todas las lecciones completadas.')) {
            // Eliminar solo las lecciones completadas, no la preferencia de dark mode ni el perfil
            const keysToRemove = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('lessonProgress_')) {
                    keysToRemove.push(key);
                }
            }
            keysToRemove.forEach(key => localStorage.removeItem(key));

            // Asegurarse de que lesson1 se marque como unlocked de nuevo
            saveProgress('lesson1', 'unlocked');

            actualizarEstadoLecciones();
            displayProgress(); // Actualizar la vista de progreso
            alert('Tu progreso ha sido reiniciado.');
        }
    }

    function cerrarSesion() {
      alert('Sesión cerrada.');
      // Aquí puedes añadir lógica para limpiar tokens o redirigir
      // window.location.href = 'login.html'; // Ejemplo de redirección
    }

    // --- NUEVO JAVASCRIPT PARA PROGRESO Y DESBLOQUEO DE LECCIONES ---

    const MIN_PASS_SCORE = 70; // Puntaje mínimo global para aprobar si no se especifica en la lección

    // Función para cargar el progreso desde localStorage
    function loadProgress() {
        const lessons = document.querySelectorAll('.lesson-card');
        lessons.forEach(lesson => {
            const lessonId = lesson.id; // Usamos el ID del div de la lección
            const progress = localStorage.getItem(`lessonProgress_${lessonId}`);
            if (progress === 'completed') {
                lesson.classList.add('completed');
                const existingCheck = lesson.querySelector('.check');
                if (!existingCheck) { // Evitar duplicados
                    lesson.innerHTML += '<span class="check">✅</span>';
                }
                // Si la lección tiene quiz, podrías mostrar el resultado aquí si lo guardas
            }
        });
        updateLessonAvailability(); // Asegura que las lecciones se desbloqueen correctamente al cargar
        updateProgressBar(); // Actualizar la barra de progreso al cargar
    }

    // Función para guardar el progreso en localStorage
    function saveProgress(lessonId, status) {
        localStorage.setItem(`lessonProgress_${lessonId}`, status);
        updateProgressBar(); // Actualizar la barra de progreso cada vez que se guarda el progreso
    }

    // Función para actualizar el estado de bloqueo/desbloqueo de las lecciones
    function updateLessonAvailability() {
        const lessons = document.querySelectorAll('.lesson-card');
        for (let i = 0; i < lessons.length; i++) {
            const currentLesson = lessons[i];
            const currentLessonId = currentLesson.id;
            const leccionDataId = parseInt(currentLesson.dataset.leccionId); // Su 'leccion-id'

            const isCurrentLessonCompleted = localStorage.getItem(`lessonProgress_${currentLessonId}`) === 'completed';

            // Limpiar clases y mensajes de bloqueo/desbloqueo anteriores
            currentLesson.classList.remove('locked');
            currentLesson.style.pointerEvents = "auto";
            currentLesson.onclick = () => cargarLeccion(leccionDataId); // Restablecer el click event
            let unlockMessage = currentLesson.querySelector('.unlock-message');
            if (unlockMessage) {
                unlockMessage.remove();
            }

            // La primera lección siempre está desbloqueada por defecto
            if (leccionDataId === 1) { // Usa data-leccion-id para la primera lección
                if (localStorage.getItem(`lessonProgress_${currentLessonId}`) === null) {
                    saveProgress(currentLessonId, 'unlocked');
                }
                continue; // Ya procesada, pasar a la siguiente
            }

            const previousLesson = document.querySelector(`.lesson-card[data-leccion-id="${leccionDataId - 1}"]`);
            if (!previousLesson) { // Si no hay lección anterior (debería existir si no es la primera)
                console.warn(`No se encontró la lección anterior para ${currentLessonId}`);
                continue;
            }

            const previousLessonId = previousLesson.id; // El ID HTML de la lección anterior
            const previousQuizRequired = previousLesson.dataset.quizRequired === 'true';
            const isPreviousLessonCompleted = localStorage.getItem(`lessonProgress_${previousLessonId}`) === 'completed';

            if (previousQuizRequired) {
                // Si la lección anterior requería cuestionario
                if (isPreviousLessonCompleted) {
                    currentLesson.classList.remove('locked');
                    saveProgress(currentLessonId, 'unlocked');
                } else {
                    currentLesson.classList.add('locked');
                    currentLesson.style.pointerEvents = "none"; // Desactivar clics
                    currentLesson.onclick = null; // Quitar el evento onclick
                    if (!unlockMessage) { // Si no existe el mensaje, crearlo
                        unlockMessage = document.createElement('p');
                        unlockMessage.classList.add('unlock-message');
                        currentLesson.appendChild(unlockMessage);
                    }
                    unlockMessage.textContent = 'Completa el cuestionario anterior para desbloquear';
                    saveProgress(currentLessonId, 'locked');
                }
            } else {
                // Si la lección anterior NO requería cuestionario, solo se necesita que la anterior esté "unlocked" o "completed"
                const isPreviousLessonUnlockedOrCompleted = localStorage.getItem(`lessonProgress_${previousLessonId}`) === 'unlocked' || isPreviousLessonCompleted;
                if (isPreviousLessonUnlockedOrCompleted) {
                    currentLesson.classList.remove('locked');
                    saveProgress(currentLessonId, 'unlocked');
                } else {
                    currentLesson.classList.add('locked');
                    currentLesson.style.pointerEvents = "none";
                    currentLesson.onclick = null;
                    if (!unlockMessage) {
                        unlockMessage = document.createElement('p');
                        unlockMessage.classList.add('unlock-message');
                        currentLesson.appendChild(unlockMessage);
                    }
                    unlockMessage.textContent = 'Completa la lección anterior para desbloquear';
                    saveProgress(currentLessonId, 'locked');
                }
            }

            // Si la lección actual ya está completada, asegúrate de que tenga el ✅
            if (isCurrentLessonCompleted) {
                currentLesson.classList.add('completed');
                const existingCheck = currentLesson.querySelector('.check');
                if (!existingCheck) {
                    currentLesson.innerHTML += '<span class="check">✅</span>';
                }
            } else {
                // Si no está completada, asegurar que no tenga el ✅
                const existingCheck = currentLesson.querySelector('.check');
                if (existingCheck) {
                    existingCheck.remove();
                }
            }
        }
    }

    // Función para simular el envío de un cuestionario
    // Esta función se llamará desde tus archivos de cuestionario (ej. desde un botón de envío)
    function submitQuiz(lessonId, scoreObtained) { // lessonId debe ser el ID del div de la lección (ej. 'lesson2')
        const lessonElement = document.getElementById(lessonId);
        if (!lessonElement) {
            console.error(`Lección con ID ${lessonId} no encontrada.`);
            return;
        }

        const minScore = parseInt(lessonElement.dataset.minScore) || MIN_PASS_SCORE;
        let passed = false;

        if (scoreObtained >= minScore) {
            passed = true;
            alert(`¡Cuestionario de ${lessonElement.dataset.titulo} aprobado con ${scoreObtained}%!`);
            saveProgress(lessonId, 'completed');
        } else {
            alert(`Cuestionario de ${lessonElement.dataset.titulo} reprobado con ${scoreObtained}%. Necesitas ${minScore}%.`);
            saveProgress(lessonId, 'unlocked'); // Si reprueba, la lección sigue "desbloqueada" pero no "completada"
        }

        updateLessonAvailability(); // Actualizar el estado de las lecciones después de enviar el cuestionario
        displayProgress(); // Actualizar la vista de progreso
    }

    // Función para manejar el clic en las tarjetas de lección (para ir a la lección)
    function cargarLeccion(leccionDataId) {
        const lessonElement = document.querySelector(`.lesson-card[data-leccion-id="${leccionDataId}"]`);
        const lessonId = lessonElement.id; // El ID HTML de la lección

        // Si la lección no tiene cuestionario obligatorio y está desbloqueada, marcarla como completada al hacer clic
        if (lessonElement.dataset.quizRequired !== 'true' && localStorage.getItem(`lessonProgress_${lessonId}`) === 'unlocked') {
            saveProgress(lessonId, 'completed');
        }

        window.location.href = `lesson${leccionDataId}.html`; // Redirige a la página de la lección
    }

    // Función para actualizar la barra de progreso
    function updateProgressBar() {
        const totalLessons = document.querySelectorAll('.lesson-card').length;
        let completedLessonsCount = 0;
        document.querySelectorAll('.lesson-card').forEach(lesson => {
            const lessonId = lesson.id;
            if (localStorage.getItem(`lessonProgress_${lessonId}`) === 'completed') {
                completedLessonsCount++;
            }
        });
        const progressPercentage = (totalLessons > 0) ? (completedLessonsCount / totalLessons) * 100 : 0;
        document.getElementById('progressFill').style.width = `${progressPercentage}%`;
    }

    // Función para mostrar el progreso en la sección "Progreso"
    function displayProgress() {
        const listaProgreso = document.getElementById('lista-progreso');
        listaProgreso.innerHTML = ''; // Limpiar lista
        const lessons = document.querySelectorAll('.lesson-card');
        lessons.forEach(lesson => {
            const lessonId = lesson.id;
            const title = lesson.dataset.titulo;
            const status = localStorage.getItem(`lessonProgress_${lessonId}`) || 'locked'; // 'locked', 'unlocked', 'completed'

            const listItem = document.createElement('li');
            let statusText = '';
            let statusColor = '';

            switch (status) {
                case 'completed':
                    statusText = '✅ Completada';
                    statusColor = 'green';
                    break;
                case 'unlocked':
                    statusText = '➡️ Desbloqueada (Pendiente)';
                    statusColor = 'orange';
                    break;
                case 'locked':
                    statusText = '🔒 Bloqueada';
                    statusColor = 'red';
                    break;
                default:
                    statusText = 'Estado desconocido';
                    statusColor = 'gray';
            }
            listItem.innerHTML = `${title}: <span style="color: ${statusColor};">${statusText}</span>`;
            listaProgreso.appendChild(listItem);
        });
    }

    // Asegurarse de que todo se inicialice al cargar la página
    document.addEventListener('DOMContentLoaded', () => {
        aplicarModoOscuroInicial();
        loadProgress(); // Carga el progreso inicial y actualiza la disponibilidad de las lecciones
        updateProgressBar(); // Asegura que la barra de progreso se actualice
    });

    // Añadir event listener para hacer click en la tarjeta y cargar la lección o marcar como completada (si no tiene quiz)
    document.querySelectorAll('.lesson-card').forEach(card => {
        card.addEventListener('click', () => {
            const leccionDataId = parseInt(card.dataset.leccionId);
            cargarLeccion(leccionDataId);
        });
    });

  </script>
</body>
</html>
